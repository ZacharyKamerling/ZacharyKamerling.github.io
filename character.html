<!DOCTYPE html>
<html>

<head>
    <title>Character Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #222;
            color: #fff;
        }
        .character-sheet {
            color: #fff;
        }
        input, select, textarea, button {
            background: #333;
            color: #fff;
            border: 1px solid #444;
        }
        ::selection {
            background: #444;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="character-sheet">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1em;">
            <div id="character-name" style="font-size: 1.5em; font-weight: 500; padding-left: 0.5em;"></div>
            <a href="index.html" title="Return to Character List" style="color: #fff; text-decoration: none; font-size: 1.7em; padding-right: 0.5em;">
                <span style="vertical-align: middle;">&#8962;</span>
            </a>
        </div>
        <div id="token-section"></div>
        <div id="stat-section"></div>
        <!-- Dice Rollers (to be expanded) -->
    </div>

    <script src="db.js"></script>
    <script>
        // Load character data
        const characterId = new URLSearchParams(window.location.search).get('id');
        const character = db.getCharacter(characterId);
        if (!character) {
            alert("Character not found!");
            window.location.href = "index.html";
        }

        function renderTokens() {
            let blood = '';
            let maxBlood = character.bloodMax || 1;
            let currentBlood = character.bloodTokens || 0;
            for (let i = 0; i < maxBlood; i++) {
                blood += `<button class="token-btn" data-type="blood" data-idx="${i}" style="font-size:1.5em; margin:2px 2px;${i < currentBlood ? '' : 'opacity:0.3;'}">ðŸ©¸</button>`;
            }
            let stamina = '';
            let maxStamina = character.staminaMax || 1;
            let currentStamina = character.staminaTokens || 0;
            for (let i = 0; i < maxStamina; i++) {
                stamina += `<button class="token-btn" data-type="stamina" data-idx="${i}" style="font-size:1.5em; margin:2px 2px;${i < currentStamina ? '' : 'opacity:0.3;'}">âš¡</button>`;
            }
            const tokenSection = document.getElementById('token-section');
            if (!tokenSection) return;
            tokenSection.innerHTML = `
                <div style="font-size:1.2em; margin-bottom:0.5em; display: flex; flex-direction: column; gap: 0.5em;">
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                        <span id="blood-label" style="padding-left: 0.5em; font-size: 1em;">Blood (${currentBlood} / ${maxBlood})</span>
                        <div>${blood}</div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                        <span id="stamina-label" style="padding-left: 0.5em; font-size: 1em;">Stamina (${currentStamina} / ${maxStamina})</span>
                        <div>${stamina}</div>
                    </div>
                </div>
            `;

            // Clicking a token sets current to that value (contiguous) and long-press sets max
            document.querySelectorAll('.token-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const type = btn.dataset.type;
                    const idx = parseInt(btn.dataset.idx);
                    if (type === 'blood') {
                        if (idx === 0 && character.bloodTokens === 1) {
                            character.bloodTokens = 0;
                        } else {
                            character.bloodTokens = idx + 1;
                        }
                    }
                    if (type === 'stamina') {
                        if (idx === 0 && character.staminaTokens === 1) {
                            character.staminaTokens = 0;
                        } else {
                            character.staminaTokens = idx + 1;
                        }
                    }
                    db.saveCharacter(character);
                    renderTokens();
                };
                // Hold-to-set-max on any token
                let holdTimer;
                btn.addEventListener('mousedown', (e) => {
                    holdTimer = setTimeout(() => {
                        const type = btn.dataset.type;
                        let label = type === 'blood' ? 'Blood' : 'Stamina';
                        let maxProp = type === 'blood' ? 'bloodMax' : 'staminaMax';
                        let valueProp = type === 'blood' ? 'bloodTokens' : 'staminaTokens';
                        let val = prompt(`Set max ${label} (1-20):`, character[maxProp] || 5);
                        val = Math.max(1, Math.min(20, parseInt(val)));
                        if (!isNaN(val)) {
                            character[maxProp] = val;
                            if (character[valueProp] > val) character[valueProp] = val;
                            db.saveCharacter(character);
                            renderTokens();
                        }
                    }, 600);
                });
                btn.addEventListener('mouseup', () => clearTimeout(holdTimer));
                btn.addEventListener('mouseleave', () => clearTimeout(holdTimer));
                btn.addEventListener('touchstart', (e) => {
                    holdTimer = setTimeout(() => {
                        const type = btn.dataset.type;
                        let label = type === 'blood' ? 'Blood' : 'Stamina';
                        let maxProp = type === 'blood' ? 'bloodMax' : 'staminaMax';
                        let valueProp = type === 'blood' ? 'bloodTokens' : 'staminaTokens';
                        let val = prompt(`Set max ${label} (1-20):`, character[maxProp] || 5);
                        val = Math.max(1, Math.min(20, parseInt(val)));
                        if (!isNaN(val)) {
                            character[maxProp] = val;
                            if (character[valueProp] > val) character[valueProp] = val;
                            db.saveCharacter(character);
                            renderTokens();
                        }
                    }, 600);
                });
                btn.addEventListener('touchend', () => clearTimeout(holdTimer));
                btn.addEventListener('touchcancel', () => clearTimeout(holdTimer));
            });
        }

        // Render stats
        function renderStats() {
            const statSection = document.getElementById('stat-section');
            if (!statSection) return;
            statSection.innerHTML = `
                <div style="font-size:1.2em; display: flex; flex-direction: column; gap: 0.3em; max-width: 18em;">
                    <div style="display: flex; align-items: center;">
                        <div style="width: 9em; min-width: 9em; text-align: left; padding-left: 0.5em; padding-right: 0.5em; white-space: nowrap;"><span id="melee-power-label" title="Melee Power">Melee Power</span></div>
                        <div style="width: 2.5em; text-align: left;">${character.meleePower || 0}d6</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 9em; min-width: 9em; text-align: left; padding-left: 0.5em; padding-right: 0.5em; white-space: nowrap;"><span id="ranged-power-label" title="Ranged Power">Ranged Power</span></div>
                        <div style="width: 2.5em; text-align: left;">${character.rangedPower || 0}d6</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 9em; min-width: 9em; text-align: left; padding-left: 0.5em; padding-right: 0.5em; white-space: nowrap;"><span id="might-label" title="Might">Might</span></div>
                        <div style="width: 2.5em; text-align: left;">${character.might || 0}d6</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 9em; min-width: 9em; text-align: left; padding-left: 0.5em; padding-right: 0.5em; white-space: nowrap;"><span id="awareness-label" title="Awareness">Awareness</span></div>
                        <div style="width: 2.5em; text-align: left;">${character.awareness || 0}d6</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 9em; min-width: 9em; text-align: left; padding-left: 0.5em; padding-right: 0.5em; white-space: nowrap;"><span id="resolve-label" title="Resolve">Resolve</span></div>
                        <div style="width: 2.5em; text-align: left;">${character.resolve || 0}d6</div>
                    </div>
                </div>
            `;
            addHoldToSetMax('melee-power-label', 'Melee Power', 'meleePower');
            addHoldToSetMax('ranged-power-label', 'Ranged Power', 'rangedPower');
            addHoldToSetMax('might-label', 'Might', 'might');
            addHoldToSetMax('awareness-label', 'Awareness', 'awareness');
            addHoldToSetMax('resolve-label', 'Resolve', 'resolve');
        }

        // Utility: add hold-to-set-MAX-value to a label
        function addHoldToSetMax(id, label, maxProp) {
            const el = document.getElementById(id);
            if (!el) return;
            let holdTimer;
            el.addEventListener('mousedown', (e) => {
                holdTimer = setTimeout(() => {
                    let val = prompt(`Set max ${label} (1-20):`, character[maxProp] || 5);
                    val = Math.max(1, Math.min(20, parseInt(val)));
                    if (!isNaN(val)) {
                        character[maxProp] = val;
                        db.saveCharacter(character);
                        renderTokens();
                    }
                }, 600);
            });
            el.addEventListener('mouseup', () => clearTimeout(holdTimer));
            el.addEventListener('mouseleave', () => clearTimeout(holdTimer));
            el.addEventListener('touchstart', (e) => {
                holdTimer = setTimeout(() => {
                    let val = prompt(`Set max ${label} (1-20):`, character[maxProp] || 5);
                    val = Math.max(1, Math.min(20, parseInt(val)));
                    if (!isNaN(val)) {
                        character[maxProp] = val;
                        db.saveCharacter(character);
                        renderTokens();
                        renderStats();
                    }
                }, 600);
            });
            el.addEventListener('touchend', () => clearTimeout(holdTimer));
            el.addEventListener('touchcancel', () => clearTimeout(holdTimer));
        }

        renderTokens();
        renderStats();
        // Set character name at the top
        const nameDiv = document.getElementById('character-name');
        if (nameDiv) nameDiv.textContent = character.name || 'Unnamed Character';
    </script>
</body>

</html>